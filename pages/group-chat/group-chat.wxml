<!--pages/group-chat/group-chat.wxml-->
<view class="group-chat-container">
  <!-- é¡¶éƒ¨å¯¼èˆªæ  - V7è®¾è®¡ -->
  <view class="top-nav">
    <view class="nav-left">
      <view class="back-btn" bindtap="goBack">
        <text class="back-icon">â†</text>
      </view>
    </view>
    
    <view class="nav-center">
      <view class="group-info">
        <text class="group-name">{{groupName}}</text>
        <view class="group-meta">
          <text class="member-count">{{groupInfo.memberCount || 0}}äºº</text>
          <text class="group-status">æ´»è·ƒ</text>
        </view>
      </view>
    </view>
    
    <view class="nav-right">
      <view class="nav-btn member-btn" bindtap="showMemberList">
        <text class="nav-icon">ğŸ‘¥</text>
      </view>
      <view class="nav-btn add-ai-btn" bindtap="showAddAISelector">
        <text class="nav-icon">+</text>
      </view>
    </view>
  </view>

  <!-- AIçŠ¶æ€æ˜¾ç¤ºæ  - V7è®¾è®¡ -->
  <view class="ai-status-bar" wx:if="{{multiAIMode && activeAIs.length > 0}}">
    <view class="status-bar-header">
      <view class="status-title">
        <text class="status-icon">ğŸ¤–</text>
        <text class="status-text">AIåŠ©æ‰‹</text>
      </view>
      <text class="status-count">{{activeAIs.length}}/5 å·²æ¿€æ´»</text>
    </view>
    
    <scroll-view class="ai-status-list" scroll-x="true" show-scrollbar="false">
      <view 
        class="ai-status-item {{item.isActive ? 'active' : 'inactive'}}" 
        wx:for="{{aiStatusList}}" 
        wx:key="id"
        data-ai-id="{{item.id}}"
        bindtap="toggleAIStatus"
      >
        <view class="ai-avatar">
          <text class="ai-emoji">{{item.avatar}}</text>
          <view class="ai-status-dot {{item.isActive ? 'online' : 'offline'}}"></view>
        </view>
        <text class="ai-name">{{item.nickname}}</text>
        <view class="ai-toggle {{item.isActive ? 'active' : ''}}">
          <text class="toggle-icon">{{item.isActive ? 'âœ“' : 'â—‹'}}</text>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- æ¶ˆæ¯åˆ—è¡¨åŒºåŸŸ - V7è®¾è®¡ -->
  <scroll-view 
    class="message-list" 
    scroll-y="true" 
    scroll-into-view="{{scrollToView}}"
    scroll-with-animation="true"
    bindscrolltoupper="onLoadMore"
    bindscroll="onScroll"
    refresher-enabled="true"
    bindrefresherrefresh="onPullDownRefresh"
    refresher-triggered="{{refreshing}}"
    show-scrollbar="false"
  >
    <!-- åŠ è½½æ›´å¤šæç¤º -->
    <view class="load-more" wx:if="{{loading}}">
      <view class="loading-spinner"></view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>

    <!-- æ¶ˆæ¯åˆ—è¡¨ -->
    <view class="message-item" wx:for="{{messageList}}" wx:key="id" id="msg-{{item.id}}">
      <!-- ç”¨æˆ·æ¶ˆæ¯ -->
      <view class="message user-message" wx:if="{{item.role === 'user'}}">
        <view class="message-avatar user-avatar">
          <text class="avatar-emoji">ğŸ‘¤</text>
        </view>
        <view class="message-content">
          <view class="message-bubble user-bubble">
            <text class="message-text">{{item.content}}</text>
          </view>
          <view class="message-time">{{item.time}}</view>
        </view>
      </view>

      <!-- AIæ¶ˆæ¯ -->
      <view class="message ai-message" wx:elif="{{item.role === 'assistant'}}">
        <view class="message-avatar ai-avatar">
          <text class="avatar-emoji">{{item.aiCharacter.avatar || 'ğŸ¤–'}}</text>
        </view>
        <view class="message-content">
          <view class="ai-identity" wx:if="{{item.aiCharacter}}">
            <text class="ai-name">{{item.aiCharacter.nickname}}</text>
            <text class="ai-personality">{{item.aiCharacter.name}}</text>
          </view>
          <view class="message-bubble ai-bubble">
            <text class="message-text">{{item.content}}</text>
          </view>
          <view class="message-time">{{item.time}}</view>
        </view>
      </view>

      <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
      <view class="message system-message" wx:elif="{{item.role === 'system' || item.isSystemMessage}}">
        <view class="message-bubble system-bubble">
          <text class="message-text">{{item.content}}</text>
        </view>
      </view>
    </view>

    <!-- å‘é€ä¸­æç¤º -->
    <view class="sending-indicator" wx:if="{{sending}}">
      <view class="typing-dots">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
      <text class="sending-text">AIæ­£åœ¨æ€è€ƒä¸­...</text>
    </view>
  </scroll-view>

  <!-- è¾“å…¥åŒºåŸŸ - V7è®¾è®¡ -->
  <view class="input-area">
    <view class="input-container">
      <view class="input-wrapper">
        <input 
          class="message-input" 
          placeholder="è¾“å…¥æ¶ˆæ¯..." 
          placeholder-class="input-placeholder"
          value="{{inputMessage}}"
          bindinput="onInputChange"
          bindconfirm="sendMessage"
          bindfocus="onInputFocus"
          bindblur="onInputBlur"
          bindtap="onInputTap"
          confirm-type="send"
          maxlength="500"
          focus="{{inputFocused}}"
          cursor-spacing="20"
        />
        <view class="input-actions">
          <view class="action-btn emoji-btn">
            <text class="action-icon">ğŸ˜Š</text>
          </view>
        </view>
      </view>
      <view class="send-btn {{inputMessage ? 'active' : ''}}" bindtap="sendMessage">
        <text class="send-icon">â†’</text>
      </view>
    </view>
  </view>

  <!-- æ·»åŠ AIé€‰æ‹©å™¨å¼¹çª— - V7è®¾è®¡ -->
  <view class="modal-overlay {{showAddAISelector ? 'show' : ''}}" bindtap="hideAddAISelector">
    <view class="modal-content add-ai-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æ·»åŠ AIåŠ©æ‰‹</text>
        <view class="close-btn" bindtap="hideAddAISelector">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="ai-stats">
          <view class="stat-item">
            <text class="stat-value">{{activeAIs.length}}</text>
            <text class="stat-label">å½“å‰æ¿€æ´»</text>
          </view>
          <view class="stat-divider"></view>
          <view class="stat-item">
            <text class="stat-value">{{5 - activeAIs.length}}</text>
            <text class="stat-label">å¯æ·»åŠ </text>
          </view>
        </view>
        
        <scroll-view class="ai-list" scroll-y="true" show-scrollbar="false">
          <view 
            class="ai-item" 
            wx:for="{{availableAIs}}" 
            wx:key="id"
            data-ai-id="{{item.id}}"
            bindtap="selectAIToAdd"
          >
            <view class="ai-item-avatar">
              <text class="ai-item-emoji">{{item.avatar || 'ğŸ¤–'}}</text>
            </view>
            <view class="ai-item-info">
              <text class="ai-item-name">{{item.nickname}}</text>
              <text class="ai-item-type">{{item.personality}}</text>
              <text class="ai-item-desc">{{item.description}}</text>
            </view>
            <view class="ai-item-action">
              <view class="add-ai-btn">
                <text class="add-icon">+</text>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>

  <!-- æˆå‘˜åˆ—è¡¨å¼¹çª— - V7è®¾è®¡ -->
  <view class="modal-overlay {{showMemberModal ? 'show' : ''}}" bindtap="hideMemberList">
    <view class="modal-content member-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ç¾¤æˆå‘˜</text>
        <view class="close-btn" bindtap="hideMemberList">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="member-count">
          <text class="count-number">{{memberList.length}}</text>
          <text class="count-label">ä½æˆå‘˜</text>
        </view>
        
        <scroll-view class="member-list" scroll-y="true" show-scrollbar="false">
          <view wx:if="{{memberList.length === 0}}" class="no-members">
            <text class="no-members-icon">ğŸ‘¥</text>
            <text class="no-members-text">æš‚æ— æˆå‘˜ä¿¡æ¯</text>
          </view>
          <view class="member-item" wx:for="{{memberList}}" wx:key="id">
            <view class="member-avatar">
              <text class="member-emoji">{{item.avatar}}</text>
            </view>
            <view class="member-info">
              <text class="member-name">{{item.name}}</text>
              <text class="member-role">{{item.type}}</text>
            </view>
          </view>
        </scroll-view>
      </view>
    </view>
  </view>

  <!-- å…¶ä»–å¼¹çª—ä¿æŒåŸæœ‰ç»“æ„ï¼Œä½†æ ·å¼ä¼šé€šè¿‡CSSä¼˜åŒ– -->
  <!-- åˆ›å»ºç¾¤èŠå¼¹çª— -->
  <view class="modal-overlay {{showCreateGroupModal ? 'show' : ''}}" bindtap="hideCreateGroupModal">
    <view class="modal-content create-group-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">åˆ›å»ºæ–°ç¾¤èŠ</text>
        <view class="close-btn" bindtap="hideCreateGroupModal">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="form-group">
          <text class="form-label">ç¾¤èŠåç§° *</text>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°" 
            value="{{newGroupData.groupName}}"
            data-field="groupName"
            bindinput="onCreateGroupInputChange"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">ç¾¤èŠæè¿°</text>
          <textarea 
            class="form-textarea" 
            placeholder="è¯·è¾“å…¥ç¾¤èŠæè¿°" 
            value="{{newGroupData.description}}"
            data-field="description"
            bindinput="onCreateGroupInputChange"
            maxlength="200"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">ç¾¤èŠå¤´åƒ</text>
          <view class="avatar-selector" bindtap="selectGroupAvatar">
            <text class="selected-avatar">{{newGroupData.avatar}}</text>
            <text class="avatar-hint">ç‚¹å‡»é€‰æ‹©</text>
          </view>
        </view>
        
        <view class="form-group">
          <text class="form-label">æœ€å¤§æˆå‘˜æ•°</text>
          <input 
            class="form-input" 
            type="number" 
            placeholder="100" 
            value="{{newGroupData.maxMembers}}"
            data-field="maxMembers"
            bindinput="onCreateGroupInputChange"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">åˆå§‹AIåŠ©æ‰‹ *</text>
          <view class="ai-selector" bindtap="selectInitialAIs">
            <text class="ai-hint">å·²é€‰æ‹© {{newGroupData.initialAIs.length}} ä¸ªAI</text>
            <text class="ai-arrow">â–¼</text>
          </view>
          <view class="selected-ais">
            <text class="selected-ai" wx:for="{{newGroupData.initialAINames}}" wx:key="index">
              {{item}}
            </text>
          </view>
        </view>
        
        <view class="form-group">
          <text class="form-label">ç¾¤èŠè®¾ç½®</text>
          <view class="setting-item">
            <text class="setting-label">å…¬å¼€ç¾¤èŠ</text>
            <switch 
              class="setting-switch" 
              checked="{{newGroupData.isPublic}}"
              data-field="isPublic"
              bindchange="onCreateGroupInputChange"
            />
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <view class="action-btn secondary" bindtap="hideCreateGroupModal">
          <text>å–æ¶ˆ</text>
        </view>
        <view class="action-btn primary" bindtap="confirmCreateGroup">
          <text>åˆ›å»ºç¾¤èŠ</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç¾¤èŠä¿¡æ¯å¼¹çª— -->
  <view class="modal-overlay {{showGroupInfoModal ? 'show' : ''}}" bindtap="hideGroupInfoModal">
    <view class="modal-content group-info-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ç¾¤èŠä¿¡æ¯</text>
        <view class="close-btn" bindtap="hideGroupInfoModal">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="info-section">
          <view class="info-header">
            <text class="info-avatar">{{groupInfo.avatar || 'ğŸ‘¥'}}</text>
            <view class="info-basic">
              <text class="info-name">{{groupInfo.groupName}}</text>
              <text class="info-status">{{groupInfo.status === 'active' ? 'æ´»è·ƒ' : 'å·²å…³é—­'}}</text>
            </view>
          </view>
          
          <view class="info-description">
            <text class="description-text">{{groupInfo.description || 'æš‚æ— æè¿°'}}</text>
          </view>
          
          <view class="info-stats">
            <view class="stat-item">
              <text class="stat-label">æˆå‘˜æ•°</text>
              <text class="stat-value">{{groupInfo.memberCount || 0}}</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">æ¶ˆæ¯æ•°</text>
              <text class="stat-value">{{groupInfo.stats.messageCount || 0}}</text>
            </view>
            <view class="stat-item">
              <text class="stat-label">AIæ•°é‡</text>
              <text class="stat-value">{{groupInfo.activeAIs ? groupInfo.activeAIs.length : 0}}</text>
            </view>
          </view>
          
          <view class="info-tags" wx:if="{{groupInfo.tags && groupInfo.tags.length > 0}}">
            <text class="tags-label">æ ‡ç­¾ï¼š</text>
            <text class="tag-item" wx:for="{{groupInfo.tags}}" wx:key="index">{{item}}</text>
          </view>
          
          <view class="info-created">
            <text class="created-label">åˆ›å»ºæ—¶é—´ï¼š</text>
            <text class="created-time">{{groupInfo.createdAt}}</text>
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <view class="action-btn secondary" bindtap="hideGroupInfoModal">
          <text>å…³é—­</text>
        </view>
        <view class="action-btn primary" bindtap="editGroupInfo" wx:if="{{groupInfo.userRole === 'owner' || groupInfo.userRole === 'admin'}}">
          <text>ç¼–è¾‘ä¿¡æ¯</text>
        </view>
      </view>
    </view>
  </view>

  <!-- ç¼–è¾‘ç¾¤èŠä¿¡æ¯å¼¹çª— -->
  <view class="modal-overlay {{showEditGroupModal ? 'show' : ''}}" bindtap="hideEditGroupModal">
    <view class="modal-content edit-group-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">ç¼–è¾‘ç¾¤èŠä¿¡æ¯</text>
        <view class="close-btn" bindtap="hideEditGroupModal">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="form-group">
          <text class="form-label">ç¾¤èŠåç§° *</text>
          <input 
            class="form-input" 
            placeholder="è¯·è¾“å…¥ç¾¤èŠåç§°" 
            value="{{editGroupData.groupName}}"
            data-field="groupName"
            bindinput="onEditGroupInputChange"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">ç¾¤èŠæè¿°</text>
          <textarea 
            class="form-textarea" 
            placeholder="è¯·è¾“å…¥ç¾¤èŠæè¿°" 
            value="{{editGroupData.description}}"
            data-field="description"
            bindinput="onEditGroupInputChange"
            maxlength="200"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">ç¾¤èŠå¤´åƒ</text>
          <view class="avatar-selector" bindtap="selectGroupAvatar">
            <text class="selected-avatar">{{editGroupData.avatar}}</text>
            <text class="avatar-hint">ç‚¹å‡»é€‰æ‹©</text>
          </view>
        </view>
        
        <view class="form-group">
          <text class="form-label">æœ€å¤§æˆå‘˜æ•°</text>
          <input 
            class="form-input" 
            type="number" 
            placeholder="100" 
            value="{{editGroupData.maxMembers}}"
            data-field="maxMembers"
            bindinput="onEditGroupInputChange"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">ç¾¤èŠè®¾ç½®</text>
          <view class="setting-item">
            <text class="setting-label">å…¬å¼€ç¾¤èŠ</text>
            <switch 
              class="setting-switch" 
              checked="{{editGroupData.isPublic}}"
              data-field="isPublic"
              bindchange="onEditGroupInputChange"
            />
          </view>
        </view>
      </view>
      
      <view class="modal-footer">
        <view class="action-btn secondary" bindtap="hideEditGroupModal">
          <text>å–æ¶ˆ</text>
        </view>
        <view class="action-btn primary" bindtap="confirmEditGroup">
          <text>ä¿å­˜ä¿®æ”¹</text>
        </view>
      </view>
    </view>
  </view>

  <!-- æˆå‘˜ç®¡ç†å¼¹çª— -->
  <view class="modal-overlay {{showMemberManagementModal ? 'show' : ''}}" bindtap="hideMemberManagement">
    <view class="modal-content member-management-modal" catchtap="stopPropagation">
      <view class="modal-header">
        <text class="modal-title">æˆå‘˜ç®¡ç†</text>
        <view class="close-btn" bindtap="hideMemberManagement">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <view class="modal-body">
        <view class="management-actions">
          <view class="action-item" bindtap="addMember">
            <text class="action-icon">â•</text>
            <text class="action-text">æ·»åŠ æˆå‘˜</text>
          </view>
          <view class="action-item" bindtap="showMemberList">
            <text class="action-icon">ğŸ‘¥</text>
            <text class="action-text">æŸ¥çœ‹æˆå‘˜</text>
          </view>
          <view class="action-item" bindtap="transferOwnership" wx:if="{{groupInfo.userRole === 'owner'}}">
            <text class="action-icon">ğŸ‘‘</text>
            <text class="action-text">è½¬è®©ç¾¤ä¸»</text>
          </view>
        </view>
        
        <view class="member-list-section">
          <text class="section-title">å½“å‰æˆå‘˜ ({{memberList.length}})</text>
          <scroll-view class="member-list-scroll" scroll-y="true" show-scrollbar="false">
            <view class="member-item" wx:for="{{memberList}}" wx:key="openid">
              <view class="member-avatar">
                <text class="member-emoji">{{item.avatarUrl || 'ğŸ‘¤'}}</text>
              </view>
              <view class="member-info">
                <text class="member-name">{{item.nickName || 'æœªçŸ¥ç”¨æˆ·'}}</text>
                <text class="member-role">{{item.role === 'owner' ? 'ç¾¤ä¸»' : item.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æˆå‘˜'}}</text>
                <text class="member-joined">åŠ å…¥æ—¶é—´ï¼š{{item.joinedAt}}</text>
              </view>
              <view class="member-actions" wx:if="{{groupInfo.userRole === 'owner' || (groupInfo.userRole === 'admin' && item.role === 'member')}}">
                <view class="remove-btn" 
                  data-member-openid="{{item.openid}}" 
                  data-member-name="{{item.nickName || 'æœªçŸ¥ç”¨æˆ·'}}"
                  bindtap="removeMember"
                  wx:if="{{item.role !== 'owner'}}"
                >
                  <text class="remove-text">ç§»é™¤</text>
                </view>
              </view>
            </view>
          </scroll-view>
        </view>
      </view>
      
      <view class="modal-footer">
        <view class="action-btn secondary" bindtap="hideMemberManagement">
          <text>å…³é—­</text>
        </view>
        <view class="action-btn danger" bindtap="leaveGroup" wx:if="{{groupInfo.userRole !== 'owner'}}">
          <text>ç¦»å¼€ç¾¤èŠ</text>
        </view>
      </view>
    </view>
  </view>

</view>

