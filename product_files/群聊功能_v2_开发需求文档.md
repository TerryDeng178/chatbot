# 群聊功能 第二版开发需求文档（V2）

文档目的：将“首页群聊 + 仅用户在线时活跃（省成本）+ 预置主题群免邀请可入”方案沉淀为开发需求，指导前后端一致落地。
版本：v2（第二版）  适用范围：仅改造 Home 页面与相关云函数/数据结构，导航栏下“角色/设置”等既有页面不改动。

一、背景与目标
- 背景：在已有一对一聊天能力基础上，新增“群聊”体验；用户进入 APP 的首页即可看到多个预置主题群，免邀请点击即入，体验类似微信群。
- 目标：
  1) 首页可见多个预置主题群卡片，展示最新动态与未读提示；
  2) 免邀请加入：点击群卡片即可进入群聊；
  3) AI 活跃省成本：仅在用户在线/活跃时触发 AI 发言或“有更新”提示，不做离线补课；
  4) 右下“+”创建自定义群；
  5) 不影响现有“角色/设置”等页面与导航。

二、范围与不做什么
- 做什么：仅改造 pages/home（home.js/wxml/wxss/json）作为群聊入口与列表；新增必要的群聊详情页（如 pages/group-chat）与云函数；扩展必要的数据结构。
- 不做什么：不调整 tabBar 配置；不改动“角色/设置”等既有页面；不做复杂社交（如搜索全网群、好友系统、语音/视频）。

三、关键用户场景（Happy Path）
1) 首次进入首页：看到 3~6 个预置主题群（如「情绪调节」「职场解压」「树洞夜聊」），卡片上展示群名/简介、最近一条消息摘要、人数、未读红点/更新标记。
2) 点击任一群卡片：无需邀请，直接进入群聊；若首次进入，该群自动把用户标记为成员；AI 会在活跃策略允许时继续自然交流。
3) 发送消息：用户在群内正常发言，AI 在节流/频控与活跃校验通过时进行回应或引导话题。
4) 返回首页：对应群卡片显示最新一条与未读数，排序按未读优先+最近活跃。
5) “+”按钮：可创建自定义主题群，命名后立即可用，可选择添加 1~N 个 Bot 角色。

四、首页呈现与交互
- 预置主题群：至少 3 个，支持后端配置，首包即可看到开场消息（由“种子消息”预置或模拟生成）。
- 群卡片内容：
  - 标题（群名）与短简介
  - 最近一条消息摘要 + 时间
  - 成员人数（或活跃数）
  - 未读红点/更新标记（仅在用户在线期间产生的新内容计入）
- 排序规则：置顶官方预置群（可配置） > 有未读的群 > 最近活跃时间倒序。
- 右下角“+”：创建群弹层（群名、主题、可选 Bot 角色模板），创建成功后跳转群聊页。

五、加入与进入逻辑
- 免邀请：点击即入；若用户未在 GroupMembers 中，进入时自动插入成员记录（幂等）。
- 首次准备：预置群与开场消息通过“初始化任务/脚本”或云函数预置，保证首页即有看点。
- 退群与再次进入：MVP 可不支持退群；若后续支持退群，再次进入同样自动加入。

六、AI 活跃策略（省成本核心）
- 活跃驱动：仅在“用户在线/活跃”时触发 AI 发言或抛出“有更新”提示；APP 退到后台或关闭后即停止触发。
- 在线判定：前端进入首页/群聊页时上报心跳（user-report-presence），后端仅在心跳窗口内（如近 30s）认可为在线。
- 触发边界：
  - 用户发言后可触发 AI 单轮回应（同群内多 Bot 时按轮转/概率触发，严格频控）。
  - 长时间无人发言但用户仍在线时，可按冷启动策略抛出“找话题/今日话题”提示（最小间隔如 ≥3 分钟）。
  - 不补课：离线期间不追发历史 AI 消息；首页“有更新”可基于轻量规则在用户回到前台后再行触发。
- 频控与配额：
  - 单用户/单群/全局三级限流（如 1 分钟内最多 1 次 AI 响应 / 5 分钟内最多 3 次 / 日配额上限）。
  - 上下文摘要：超过阈值滚动窗口+摘要，控制 Token。

七、数据与接口
- 复用云函数：
  - chat-list-groups（列出用户可见群，含最近消息与未读）
  - chat-get-messages（分页拉取群内消息）
  - chat-send-message（发送消息——用户或 Bot）
- 新增云函数：
  - user-report-presence：上报前台心跳（userId、ts、page=home|group-chat），用于在线校验与频控基线。
  - chat-create-group：创建自定义群（名称/主题/Bot 配置），初始化入群与系统开场词。
  - chat-ai-greet：当用户在线、且满足频控条件时，由后端挑选合适 Bot 生成欢迎/找话题消息。
- 数据模型扩展（集合建议）：
  - Groups：{ id, name, topic, isPreset, lastMessage, lastActiveAt, pinned }
  - GroupMembers：{ groupId, userId, role=user|bot, joinedAt, lastReadAt }
  - Bots：{ id, name, persona, groupId? }
  - Messages：{ id, groupId, senderId(user|bot), content, type, createdAt, meta }
  - Presence：{ userId, lastPingAt, currentPage }

八、状态与同步
- 前台心跳：进入首页/群聊页立即上报，并每 25s 续约一次；离开页面或小程序进入后台停止上报。
- 未读计算：未读=该群最新消息时间点之后 - 用户 lastReadAt；进入群聊页即写入已读（节流 2~3s 合并写）。
- 同步策略：首页列表每次进入刷新一次；停留期间每 30~60s 轻量刷新（仅在在线时）。群聊页使用轮询/长轮询（MVP），后续可切换实时推送。

九、权限与风险控制
- 预置群为公开可见；自建群默认私有但成员免邀请（链接/二维码邀约留待后续）。
- 敏感词与滥用：发送前与生成后双重审核（基础关键词 + 违规分类标记），违规则降权或拒绝发送，并提示用户。
- 幂等与事务：创建群、自动入群、AI 发送等关键流程均要求幂等校验，避免重复与脏写。

十、埋点与指标
- 关键事件：首页曝光、卡片点击、创建群成功、群内发送成功、AI 生成成功/失败、限流命中、心跳在线时长。
- 关键指标：
  - 留存与参与：日活、进群率、发言率、AI 互动率
  - 内容与成本：AI 触发次数/人均 Token、上下文平均长度
  - 体验：平均首屏加载、群聊页首条可用时间、错误率

十一、验收标准（Definition of Done）
- 功能：
  - 首页展示 3~6 个预置主题群，卡片信息完整；
  - 免邀请点击即入群；
  - 群内可正常发送与接收消息；
  - 在线时 AI 会在频控内回应或发起话题；离线不补课；
  - “+”可创建自定义群并可用。
- 边界：
  - 无网/超时有友好提示与可重试；
  - 异常不影响其他页面；
  - 未读数与排序逻辑正确。
- 成本：
  - 单日人均 AI Token 不超过预设阈值（可配置）；
  - 频控生效，离线期间不触发 AI。

十二、默认配置（可调）
- 心跳间隔：25s；在线窗口判定：30s
- AI 静默阈值：单群 3 分钟内最多 1 次找话题
- AI 调用限额：单用户/日 50 次；单群/日 30 次（示例值）
- 首页预置群：3~6 个；群卡片展示最近 1 条消息
- 刷新策略：首页停留轻量刷新 60s；群聊页轮询 3~5s（MVP）

十三、实施计划（M1）
- P0（3~5 天）：
  - 首页群列表渲染（预置群 + 最近消息 + 未读 + 排序）
  - 免邀请入群 + 群聊页（基础消息列表/发送）
  - 心跳上报与后端在线校验；AI 单轮回应（含频控）
- P1（2~3 天）：
  - “+”创建自定义群 + 选择 Bot 模板
  - 首页轻量刷新与群聊页轮询优化
  - 种子消息/开场提示完善
- P2（持续优化）：
  - 上下文摘要/Token 成本面板、风控增强、实时推送替换轮询

附：接口清单与参数、时序图、种子群配置样例可在确认本版本后补充沉淀为《接口与数据字典_v2》与《用例集_v2》。