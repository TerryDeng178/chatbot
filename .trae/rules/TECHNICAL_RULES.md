# 技术规则 (TECHNICAL_RULES.md)

本文档是项目的技术宪章，旨在确保技术选型、架构设计和开发实践在整个项目生命周期内保持一致性、先进性和可维护性。所有开发活动都必须严格遵守本文档定义的规则。

---

### 第一章：总体架构原则 (Overall Architecture Principles)

*   **核心思想**: 我们的系统致力于成为一个**代码一次编写，多端运行**的现代化应用，同时保持**轻量、可扩展、易于维护**的特性。
*   **原则**:
    1.  **前后端分离**: 严格遵循前后端分离的模式。前端负责用户界面和交互，后端负责业务逻辑和数据。
    2.  **无状态后端服务**: 后端服务（云函数）应设计为无状态的，这使得系统可以轻松地水平扩展。
    3.  **服务化**: 核心功能（如AI聊天、用户管理）应被视为独立的“服务”，通过云函数提供。
    4.  **配置驱动**: 关键参数（如云环境ID、API密钥、功能开关）必须通过配置文件进行管理，严禁硬编码在代码中。

### 第二章：前端技术栈规则 (Frontend Stack Rules)

*   **目标**: 打造响应迅速、体验一致、代码高质量的多端（小程序、H5、App）前端应用。
*   **技术选型**:
    *   **核心框架**: **Taro (React 版本)**。这是我们实现“一次开发，多端运行”的基石。所有新页面和组件都必须使用 Taro 进行开发。
    *   **开发语言**: **TypeScript**。我们约定使用 TypeScript 来编写所有前端逻辑，以增强代码的健壮性和可维护性。
    *   **UI组件库**: **TDesign Tona**。我们约定，所有非高度定制化的UI元素，都**必须**优先使用 TDesign 提供的跨端组件库，以保证视觉和交互的统一性。
    *   **状态管理**: 项目初期，使用 **React Hooks** (`useState`, `useContext`, `useReducer`) 进行状态管理。当应用变得复杂时，我们将引入轻量级的状态管理库（如 `Zustand` 或 `Valtio`），但任何此类引入都需经过您的明确批准。
    *   **云开发集成**: **必须**使用 **Taro.cloud** API 与腾讯云开发进行交互。这是连接我们前端应用和后端云函数、数据库的唯一指定方式，确保了与现有后端资产的无缝衔接。
    *   **代码风格**: 严格遵守 `PROJECT_RULES.md` 中定义的**Prettier**代码风格。

### 第三章：后端技术栈规则 (Backend Stack Rules)

*   **目标**: 构建稳定、安全、高性能的无服务器化（Serverless）后端。
*   **技术选型**:
    *   **运行环境**: **腾讯云开发 (Tencent CloudBase)**。我们的后端完全构建于云开发之上，包括云函数、云数据库和云存储。
    *   **云函数**:
        *   **编程语言**: **Node.js**。
        *   **职责**: 负责处理所有核心业务逻辑，如用户认证、数据读写、与第三方API交互等。
    *   **数据库**: **云开发数据库 (Tencent CloudBase DB)**。作为一款NoSQL数据库，其灵活的文档模型非常适合存储聊天记录和用户配置这类非结构化、半结构化数据。
    *   **API通信**: 前后端之间**必须**通过 **Taro.cloud.callFunction** 进行通信，数据格式统一为 **JSON**。

### 第四章：API设计与文档规则 (API Design & Documentation Rules)

*   **目标**: 设计出清晰、一致、自解释的云函数接口，并保持文档的实时性。
*   **设计规则**:
    *   **命名规范**: 云函数命名应清晰地描述其功能，例如 `chat-sendMessage`, `user-login`。
    *   **参数与响应格式**: 所有云函数的输入和输出都**必须**是结构化的JSON对象。响应格式应遵循统一标准：
        ```json
        {
          "success": true, // 或 false
          "code": 200,     // 业务状态码
          "message": "操作成功", // 提示信息
          "data": { ... } // 实际返回的数据
        }
        ```
*   **文档规则**: 我们将在 `.trae/rules/TECHNICAL_ARCHITECTURE_RULES.md` 中，对核心云函数的功能、入参和出参进行清晰地记录。

### 第五章：开发与协作流程规则 (Development & Collaboration Workflow Rules)

*   **目标**: 建立一套稳健、可靠、可预测的自动化开发协作流程，最大限度地减少因手动操作或环境不一致性所引发的错误。
*   **核心原则**: **信任但验证 (Trust but Verify)**。所有自动化操作在执行关键步骤前后，都必须进行自我校验。
*   **文件操作规则 (File Operation Rules)**:
    1.  **操作前先核对 (Verify Before Write)**: 在对任何文件进行**修改或写入**操作之前，**必须**强制重新读取一次该文件的最新内容。此举旨在确保所有操作都基于磁盘上的最终版本，从根源上杜绝因内部缓存与实际文件状态不一致而导致的操作失败。
    2.  **增量化修改 (Incremental Changes)**: 鼓励将复杂的文件修改任务分解为一系列更小、逻辑独立的**增量更新**。当一次性更新失败时，应自动或在开发者指导下，尝试采用小步快跑的方式完成修改，这有助于提高操作的成功率和问题的定位效率。
    3.  **智能错误处理与自动恢复 (Intelligent Error Handling & Auto-Recovery)**: 当文件更新操作（如“查找并替换”）失败时，系统**不得**进行盲目重试。应将此类失败自动标记为“文件内容可能已过时”的信号，并立即触发内置的恢复流程：**强制重新读取文件 -> 基于最新内容重新尝试执行修改**。如果重试依然失败，必须向用户提供清晰的错误报告和上下文信息。